{% extends "base.html" %}
{% block content %}
<h2>Recommendations</h2>

<div id="context" class="muted" style="margin:8px 0 16px;"></div>
<div id="results" class="grid"></div>

<script>
const $ = s => document.querySelector(s);

async function apiJSON(url, opts={}) {
  const r = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw new Error((data && data.error && data.error.message) ? data.error.message : `HTTP ${r.status}`);
  return data;
}

function pill(text){
  const span = document.createElement('span');
  span.className = 'pill';
  span.textContent = text;
  return span;
}

const GENRES = {
  28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',99:'Documentary',
  18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',
  9648:'Mystery',10749:'Romance',878:'Science Fiction',10770:'TV Movie',53:'Thriller',
  10752:'War',37:'Western'
};

function cardFor(r){
  const div = document.createElement('div'); div.className='card';

  const img = document.createElement('img'); img.className='poster';
  img.alt = r.title || 'Poster';
  img.src = r.poster_url || 'https://dummyimage.com/600x800/0b0e13/6b7280&text=No+Poster';

  const box = document.createElement('div'); box.className='content';
  const t = document.createElement('div'); t.className='title';
  t.innerHTML = `<strong>${r.title || ''}</strong><span class="year">${r.year || ''}</span>`;

  if (r.overview) {
    const p = document.createElement('p');
    p.className = 'desc';
    p.textContent = r.overview || '';
    p.setAttribute('data-full-summary', r.overview || '');
    p.setAttribute('data-title', r.title || '');
    p.setAttribute('data-year', r.year || '');
    const more = document.createElement('span');
    more.className = 'read-more';
    more.textContent = 'Read more';
    more.setAttribute('data-full-summary', r.overview || '');
    more.setAttribute('data-title', r.title || '');
    more.setAttribute('data-year', r.year || '');
    box.append(p, more);
  }

  const genreRow = document.createElement('div'); genreRow.className = 'row wrap';
  (r.genre_ids || []).forEach(id => { if (GENRES[id]) genreRow.appendChild(pill(GENRES[id])); });
  if (genreRow.children.length) box.appendChild(genreRow);

  const controls = document.createElement('div'); controls.className='row';
  const ratingWrap = document.createElement('label'); ratingWrap.className='label'; ratingWrap.style.margin='0';
  ratingWrap.innerHTML = `My rating (0â€“10)
    <input class="input" type="number" min="0" max="10" step="1" style="width:100px" value="">`;
  const watchedWrap = document.createElement('label'); watchedWrap.className='check';
  watchedWrap.innerHTML = `<input type="checkbox"> Watched`;
  controls.append(ratingWrap, watchedWrap);

  const act = document.createElement('div'); act.className='actions';
  const add = document.createElement('button'); add.className='btn small'; add.textContent='Add';
  add.onclick = async ()=>{
    const personal_rating = ratingWrap.querySelector('input').value;
    const watched = watchedWrap.querySelector('input').checked;
    const body = { tmdb_id: r.tmdb_id };
    if (personal_rating !== '') body.personal_rating = Number(personal_rating);
    if (watched) body.watched = true;
    try{
      await apiJSON('/api/movies/from-tmdb', { method:'POST', body: JSON.stringify(body) });
      location.href = '/';
    }catch(e){ alert(e.message); }
  };
  act.append(add);

  box.append(t, controls, act);
  div.append(img, box);
  return div;
}

function renderContext(ctx){
  const el = $('#context');
  if (ctx.reason) { el.textContent = ctx.reason; return; }
  el.textContent = 'Based on your liked movies!';
}

async function run(){
  try{
    const data = await apiJSON('/api/recommendations');
    renderContext(data);
    const root = $('#results'); root.innerHTML='';
    const list = data.results || [];
    if (!list.length) {
      root.innerHTML = '<div class="muted">No suggestions yet.</div>';
      return;
    }
    list.forEach(r => root.appendChild(cardFor(r)));
  } catch(e){
    alert(e.message);
  }
}

document.addEventListener('DOMContentLoaded', run);
</script>
{% endblock %}

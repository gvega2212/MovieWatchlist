{% extends "base.html" %}
{% block content %}
<h2>Recommendations</h2>

<div id="context" class="muted" style="margin:8px 0 16px;"></div>
<div id="results" class="grid"></div>

<script>
const $ = s => document.querySelector(s);

async function apiJSON(url, opts={}) {
  const r = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw new Error((data && data.error && data.error.message) ? data.error.message : `HTTP ${r.status}`);
  return data;
}

function badge(text){
  const span = document.createElement('span');
  span.className = 'badge';
  span.textContent = text;
  return span;
}

function cardFor(r){
  const div = document.createElement('div'); div.className='card';
  const img = document.createElement('img'); img.className='poster';
  img.alt = r.title || 'Poster';
  img.src = r.poster_url || 'https://dummyimage.com/600x800/0b0e13/6b7280&text=No+Poster';

  const box = document.createElement('div'); box.className='content';
  const t = document.createElement('div'); t.className='title';
  t.innerHTML = `<strong>${r.title || ''}</strong><span class="year">${r.year || ''}</span>`;

  const meta = document.createElement('div'); meta.className='row';
  if (typeof r.vote_average === 'number') meta.appendChild(badge(`TMDB: ${r.vote_average.toFixed(1)}`));
  if (typeof r.popularity === 'number') meta.appendChild(badge(`Pop: ${Math.round(r.popularity)}`));

  const act = document.createElement('div'); act.className='actions';
  const add = document.createElement('button'); add.className='btn small'; add.textContent='Add';
  add.onclick = async ()=>{
    try{
      await apiJSON('/api/movies/from-tmdb', { method:'POST', body: JSON.stringify({ tmdb_id: r.tmdb_id }) });
      location.href = '/';
    }catch(e){ alert(e.message); }
  };
  act.append(add);

  box.append(t, meta, act);
  div.append(img, box);
  return div;
}

function renderContext(ctx){
  const el = $('#context');
  if (ctx.reason) {
    el.innerHTML = `${ctx.reason} <span class="badge">Tip</span> Mark a few movies as <strong>Watched</strong> and rate them.`;
    return;
  }
  const rmin = (ctx.params && typeof ctx.params.rmin !== 'undefined') ? ctx.params.rmin : 7;
  const seeds = (ctx.based_on || []).slice(0,5).join(', ');
  el.innerHTML = `Based on your liked movies!</em>`;
}

async function run(){
  try{
    const data = await apiJSON('/api/recommendations');
    renderContext(data);
    const root = $('#results'); root.innerHTML='';
    const list = data.results || [];
    if (!list.length) {
      root.innerHTML = '<div class="muted">No suggestions yet.</div>';
      return;
    }
    
    list.forEach(r => root.appendChild(cardFor(r)));
  } catch(e){
    alert(e.message);
  }
}

document.addEventListener('DOMContentLoaded', run);
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<h2>Add Movie (Search TMDB)</h2>

<div class="toolbar" style="gap:12px; display:flex; align-items:center; flex-wrap:wrap;">
  <input id="q" class="input" placeholder="Search a title" style="flex:1; min-width:320px;">
  <select id="suggest" class="select" title="Suggestions when empty">
    <option value="trending">Trending</option>
    <option value="top_rated">Top Rated</option>
    <option value="popular">Popular</option>
    <option value="now_playing">Now Playing</option>
  </select>
  <select id="sort" class="select">
    <option value="relevance">Relevance</option>
    <option value="rating">TMDB Rating</option>
    <option value="popularity">Popularity</option>
    <option value="year_desc">Year (newest)</option>
    <option value="year_asc">Year (oldest)</option>
    <option value="title_asc">Title (A–Z)</option>
  </select>
  <button id="go" class="btn">Search</button>
</div>

<div id="results" class="grid" style="margin-top:16px;"></div>

<script>
const $ = (s)=>document.querySelector(s);

async function apiJSON(url, opts={}) {
  const r = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw new Error((data && data.error && data.error.message) ? data.error.message : `HTTP ${r.status}`);
  return data;
}

function badge(text){
  const span = document.createElement('span');
  span.className = 'badge';
  span.textContent = text;
  return span;
}

function cardFor(r){
  const div = document.createElement('div'); div.className='card';

  const img = document.createElement('img'); img.className='poster';
  img.alt = r.title || 'Poster';
  img.src = r.poster_url || 'https://dummyimage.com/600x800/0b0e13/6b7280&text=No+Poster';

  const box = document.createElement('div'); box.className='content';
  const t = document.createElement('div'); t.className='title';
  t.innerHTML = `<strong>${r.title || ''}</strong><span class="year">${r.year || ''}</span>`;

  const meta = document.createElement('div'); meta.className='row';
  if (typeof r.vote_average === 'number') meta.appendChild(badge(`TMDB: ${r.vote_average.toFixed(1)}`));
  if (typeof r.popularity === 'number') meta.appendChild(badge(`Pop: ${Math.round(r.popularity)}`));

  const controls = document.createElement('div'); controls.className='row';
  const ratingWrap = document.createElement('label'); ratingWrap.className='label'; ratingWrap.style.margin='0';
  ratingWrap.innerHTML = `My rating (0–10)
    <input class="input" type="number" min="0" max="10" step="1" style="width:100px" value="">`;
  const watchedWrap = document.createElement('label'); watchedWrap.className='check';
  watchedWrap.innerHTML = `<input type="checkbox"> Watched`;
  controls.append(ratingWrap, watchedWrap);

  const act = document.createElement('div'); act.className='actions';
  const add = document.createElement('button'); add.className='btn small'; add.textContent='Add';
  add.onclick = async ()=>{
    const personal_rating = ratingWrap.querySelector('input').value;
    const watched = watchedWrap.querySelector('input').checked;
    const body = { tmdb_id: r.tmdb_id };
    if (personal_rating !== '') body.personal_rating = Number(personal_rating);
    if (watched) body.watched = true;
    try{
      await apiJSON('/api/movies/from-tmdb', { method:'POST', body: JSON.stringify(body) });
      location.href = '/';
    }catch(e){ alert(e.message); }
  };
  act.append(add);

  box.append(t, meta, controls, act);
  div.append(img, box);
  return div;
}

function sortResults(list, mode){
  const byNum = (f, dir=1)=> (a,b)=> ( (Number(f(a))||0) - (Number(f(b))||0) ) * dir;
  const byStr = (f)=> (a,b)=> ( (f(a)||'').localeCompare(f(b)||'') );
  switch(mode){
    case 'rating': return [...list].sort((a,b)=> (b.vote_average||0) - (a.vote_average||0));
    case 'popularity': return [...list].sort((a,b)=> (b.popularity||0) - (a.popularity||0));
    case 'year_desc': return [...list].sort(byNum(x=>x.year, -1));
    case 'year_asc': return [...list].sort(byNum(x=>x.year, +1));
    case 'title_asc': return [...list].sort(byStr(x=>x.title));
    default: return list;
  }
}

async function run(){
  const q = $('#q').value.trim();
  const sortMode = $('#sort').value;
  let url;
  if (q) {
    url = '/api/search/tmdb?q='+encodeURIComponent(q);
  } else {
    const which = $('#suggest').value;
    url = '/api/search/tmdb?default='+encodeURIComponent(which);
  }
  try{
    const data = await apiJSON(url);
    const sorted = sortResults(data.results || [], sortMode);
    const root = $('#results'); root.innerHTML='';
    sorted.forEach(r => root.appendChild(cardFor(r)));
  }catch(e){
    alert(e.message);
  }
}

let debounceTimer = null;
$('#q').addEventListener('input', ()=>{
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(run, 300);
});
$('#q').addEventListener('keydown', e => { if(e.key==='Enter') run(); });
$('#sort').addEventListener('change', run);
$('#suggest').addEventListener('change', run);
$('#go').onclick = run;

// show suggestions on initial load
document.addEventListener('DOMContentLoaded', run);
</script>
{% endblock %}
